<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pandoc - Pandoc Lua Filters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!--[if lt IE 9]>
       <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
       <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
       <![endif]-->
  <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="css/screen.css">
  <link rel="stylesheet" type="text/css" media="print" href="css/print.css">
  <style type="text/css">
      code{white-space: pre-wrap;}
      pre{ font-size: 12pt; }
      .smallcaps{font-variant: small-caps;}
      .line-block{white-space: pre-line;}
      .column{display: inline-block;}
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"
            type="text/javascript"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
  <script src="js/nav.js"></script>
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2234613-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  </script>
  <script type="text/javascript">
  /* <![CDATA[ */
    (function() {
        var s = document.createElement('script'), t = document.getElementsByTagName('script')[0];
        s.type = 'text/javascript';
        s.async = true;
        s.src = 'https://api.flattr.com/js/0.6/load.js?mode=auto';
        t.parentNode.insertBefore(s, t);
    })();
  /* ]]> */
  </script>
</head>
<body>
  <div id="doc" class="container-fluid">
    <header>
      <div id="flattr">
        <a class="FlattrButton" style="display:none;" rev="flattr;button:compact;" href="https://pandoc.org"></a>
        <noscript><a href="https://flattr.com/thing/936364/Pandoc" target="_blank"><img src="https://api.flattr.com/button/flattr-badge-large.png" alt="Flattr this" title="Flattr this" border="0" /></a></noscript>
      </div>
        <div id="paypal">
         <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----MIIHbwYJKoZIhvcNAQcEoIIHYDCCB1wCAQExggEwMIIBLAIBADCBlDCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20CAQAwDQYJKoZIhvcNAQEBBQAEgYA1aF1SYXH476Drh95jHdjCr2Pe08jgMkj9i7o+LqUNtjNpn2o2WT0G0gRm8+fSf3olG3isnZ8cJcxvV4MqvT054L2Z+erugv1UnDyEx/rmOzk+JQkDX71PmMYjQLwbyrFyU0RaVR6ksjNstM3I7bn4b8gQuSM9UkmfI/xVvslsXTELMAkGBSsOAwIaBQAwgewGCSqGSIb3DQEHATAUBggqhkiG9w0DBwQIHvq7EiOKDNOAgcjLqF4vqQA57C5WLRryItIy6xBS/tEOeAqHUR3uj65kP0HqCmwUX18IhLksKwEOc4yeDqZUo9pcPWyFRcrRxjqObs167KmrafWzCrLDRN+czf9pZUjDpYTGy0sYyW7Rt38+vLtVRHukxLkMiT3ZJ8iRd1LXx5iQRN9d8ouuS4/CsTaZoD+cv4leQR7wKpIE2LbuMx9ghOJ4kR3NSSwNYN2VyHfgONyNdQqsZCWaSO5uGXK/TnDguKoi8VSOzX2fIChhYmvdgqPtmKCCA4cwggODMIIC7KADAgECAgEAMA0GCSqGSIb3DQEBBQUAMIGOMQswCQYDVQQGEwJVUzELMAkGA1UECBMCQ0ExFjAUBgNVBAcTDU1vdW50YWluIFZpZXcxFDASBgNVBAoTC1BheVBhbCBJbmMuMRMwEQYDVQQLFApsaXZlX2NlcnRzMREwDwYDVQQDFAhsaXZlX2FwaTEcMBoGCSqGSIb3DQEJARYNcmVAcGF5cGFsLmNvbTAeFw0wNDAyMTMxMDEzMTVaFw0zNTAyMTMxMDEzMTVaMIGOMQswCQYDVQQGEwJVUzELMAkGA1UECBMCQ0ExFjAUBgNVBAcTDU1vdW50YWluIFZpZXcxFDASBgNVBAoTC1BheVBhbCBJbmMuMRMwEQYDVQQLFApsaXZlX2NlcnRzMREwDwYDVQQDFAhsaXZlX2FwaTEcMBoGCSqGSIb3DQEJARYNcmVAcGF5cGFsLmNvbTCBnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEAwUdO3fxEzEtcnI7ZKZL412XvZPugoni7i7D7prCe0AtaHTc97CYgm7NsAtJyxNLixmhLV8pyIEaiHXWAh8fPKW+R017+EmXrr9EaquPmsVvTywAAE1PMNOKqo2kl4Gxiz9zZqIajOm1fZGWcGS0f5JQ2kBqNbvbg2/Za+GJ/qwUCAwEAAaOB7jCB6zAdBgNVHQ4EFgQUlp98u8ZvF71ZP1LXChvsENZklGswgbsGA1UdIwSBszCBsIAUlp98u8ZvF71ZP1LXChvsENZklGuhgZSkgZEwgY4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UEBxMNTW91bnRhaW4gVmlldzEUMBIGA1UEChMLUGF5UGFsIEluYy4xEzARBgNVBAsUCmxpdmVfY2VydHMxETAPBgNVBAMUCGxpdmVfYXBpMRwwGgYJKoZIhvcNAQkBFg1yZUBwYXlwYWwuY29tggEAMAwGA1UdEwQFMAMBAf8wDQYJKoZIhvcNAQEFBQADgYEAgV86VpqAWuXvX6Oro4qJ1tYVIT5DgWpE692Ag422H7yRIr/9j/iKG4Thia/Oflx4TdL+IFJBAyPK9v6zZNZtBgPBynXb048hsP16l2vi0k5Q2JKiPDsEfBhGI+HnxLXEaUWAcVfCsQFvd2A1sxRr67ip5y2wwBelUecP3AjJ+YcxggGaMIIBlgIBATCBlDCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20CAQAwCQYFKw4DAhoFAKBdMBgGCSqGSIb3DQEJAzELBgkqhkiG9w0BBwEwHAYJKoZIhvcNAQkFMQ8XDTE0MDEwNjIwMjYzOVowIwYJKoZIhvcNAQkEMRYEFJLYt8/tr7y69LYjPJjKyTMm5QAYMA0GCSqGSIb3DQEBAQUABIGAI2+pZ4nP2NsnH4648MqJ7ihLLMxoiNXZTiH2yV9rknNcK0cCT28UTWnO1iFZPWNeZRMA+PclqnTS4DuGvj3+MYvGbu0NauKT9TE1eP+nrdP2XHa3qTGXcCqezVqfUxknMXyXBW5u20JGXp+D9RizEfhSX67JBLvsVwlmBYmcyYk=-----END PKCS7-----
">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
</form>
      </div>

        <span class="big">Pandoc</span>
        &nbsp;
        <span class="small">a universal document converter</span>
    </header>
    <div id="bd">
      <nav id="navbar" class="navbar nav navbar-default col-md-3 col-sm-4">
        <div class="navbar-header">
  <button type="button" class="navbar-toggle"
          data-toggle="collapse"
          data-target=".navbar-collapse">
    <span class="sr-only">Toggle navigation</span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
</div>
<div class="navbar-collapse collapse">
  <ul class="nav tree">
    <li><a href="index.html">About</a></li>
    <li><a href="installing.html">Installing</a></li>
    <li><a href="getting-started.html">Getting started</a></li>
    <li><a class="tree-toggle nav-header">Demos</a>
    <ul class="nav tree">
      <li><a href="try">Try pandoc online</a></li>
      <li><a href="demos.html">Examples</a></li>
    </ul>
    </li>
    <li><a class="tree-toggle nav-header">Documentation</a>
    <ul class="nav tree">
      <li><a href="MANUAL.html">User's Guide</a>
      <li><a href="MANUAL.pdf">User's Guide (PDF)</a>
      <li><a href="epub.html">Making an ebook</a></li>
      <li><a href="filters.html">Filters</a></li>
      <li><a href="lua-filters.html">Lua filters</a></li>
      <li><a href="CONTRIBUTING.html">Contributing</a></li>
      <li><a href="faqs.html">FAQ</a></li>
      <li><a href="press.html">Press</a></li>
      <li><a href="using-the-pandoc-api.html">Using the Pandoc API</a></li>
      <li><a href="http://hackage.haskell.org/package/pandoc">API documentation</a></li>
    </ul>
    </li>
    <li><a href="help.html">Help</a></li>
    <li><a href="https://github.com/jgm/pandoc/wiki/Pandoc-Extras">Extras</a></li>
    <li><a href="releases.html">Releases</a></li>
  </ul>
</div>
      </nav>
      <main class="col-md-9 col-sm-8">
        <div class="row">
          <h1 class="title">Pandoc Lua Filters</h1>
        <div id="toc">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#lua-filter-structure">Lua filter structure</a></li>
<li><a href="#pandoc-module">Pandoc Module</a><ul>
<li><a href="#element-creation">Element creation</a></li>
<li><a href="#exposed-pandoc-functionality">Exposed pandoc functionality</a></li>
</ul></li>
<li><a href="#lua-interpreter-initialization">Lua interpreter initialization</a></li>
<li><a href="#examples">Examples</a><ul>
<li><a href="#macro-substitution.">Macro substitution.</a></li>
<li><a href="#default-metadata-file">Default metadata file</a></li>
<li><a href="#setting-the-date-in-the-metadata">Setting the date in the metadata</a></li>
<li><a href="#extracting-information-about-links">Extracting information about links</a></li>
<li><a href="#replacing-placeholders-with-their-metadata-value">Replacing placeholders with their metadata value</a></li>
<li><a href="#modifying-pandocs-manual.txt-for-man-pages">Modifying pandoc’s <code>MANUAL.txt</code> for man pages</a></li>
<li><a href="#creating-a-handout-from-a-paper">Creating a handout from a paper</a></li>
<li><a href="#counting-words-in-a-document">Counting words in a document</a></li>
<li><a href="#converting-abc-code-to-music-notation">Converting ABC code to music notation</a></li>
<li><a href="#building-images-with-tikz">Building images with tikz</a></li>
</ul></li>
<li><a href="#module-text">Module text</a></li>
<li><a href="#module-pandoc">Module pandoc</a><ul>
<li><a href="#pandoc-document">Pandoc Document</a></li>
<li><a href="#meta">Meta</a></li>
<li><a href="#metavalue">MetaValue</a></li>
<li><a href="#blocks">Blocks</a></li>
<li><a href="#inline">Inline</a></li>
<li><a href="#element-components">Element components</a></li>
<li><a href="#constants">Constants</a></li>
<li><a href="#helper-functions">Helper functions</a></li>
</ul></li>
<li><a href="#module-pandoc.utils">Module pandoc.utils</a></li>
<li><a href="#module-pandoc.mediabag">Module pandoc.mediabag</a></li>
<li><a href="#module-pandoc.list">Module pandoc.List</a><ul>
<li><a href="#metamethods">Metamethods</a></li>
<li><a href="#methods">Methods</a></li>
</ul></li>
</ul>
        </div>
<h1 id="introduction">Introduction</h1>
<p>Pandoc has long supported filters, which allow the pandoc abstract syntax tree (AST) to be manipulated between the parsing and the writing phase. Traditional pandoc filters accept a JSON representation of the pandoc AST and produce an altered JSON representation of the AST. They may be written in any programming language, and invoked from pandoc using the <code>--filter</code> option.</p>
<p>Although traditional filters are very flexible, they have a couple of disadvantages. First, there is some overhead in writing JSON to stdout and reading it from stdin (twice, once on each side of the filter). Second, whether a filter will work will depend on details of the user’s environment. A filter may require an interpreter for a certain programming language to be available, as well as a library for manipulating the pandoc AST in JSON form. One cannot simply provide a filter that can be used by anyone who has a certain version of the pandoc executable.</p>
<p>Starting with pandoc 2.0, we have made it possible to write filters in lua without any external dependencies at all. A lua interpreter and a lua library for creating pandoc filters is built into the pandoc executable. Pandoc data types are marshalled to lua directly, avoiding the overhead of writing JSON to stdout and reading it from stdin.</p>
<p>Here is an example of a lua filter that converts strong emphasis to small caps:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">return</span> <span class="ot">{</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  <span class="ot">{</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">    Strong <span class="ot">=</span> <span class="kw">function</span> <span class="ot">(</span>elem<span class="ot">)</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">      <span class="kw">return</span> pandoc<span class="ot">.</span>SmallCaps<span class="ot">(</span>elem<span class="ot">.</span>c<span class="ot">)</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">    <span class="kw">end</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  <span class="ot">}</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="ot">}</span></a></code></pre></div>
<p>or equivalently,</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">function</span> Strong<span class="ot">(</span>elem<span class="ot">)</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="kw">return</span> pandoc<span class="ot">.</span>SmallCaps<span class="ot">(</span>elem<span class="ot">.</span>c<span class="ot">)</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">end</span></a></code></pre></div>
<p>This says: walk the AST, and when you find a Strong element, replace it with a SmallCaps element with the same content.</p>
<p>To run it, save it in a file, say <code>smallcaps.lua</code>, and invoke pandoc with <code>--lua-filter=smallcaps.lua</code>.</p>
<p>Here’s a quick performance comparison, using a version of the pandoc manual, MANUAL.txt, and versions of the same filter written in compiled Haskell (<code>smallcaps</code>) and interpreted Python (<code>smallcaps.py</code>):</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Command</th>
<th style="text-align: right;">Time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>pandoc MANUAL.txt</code></td>
<td style="text-align: right;">1.01s</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>pandoc MANUAL.txt --filter ./smallcaps</code></td>
<td style="text-align: right;">1.36s</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>pandoc MANUAL.txt --filter ./smallcaps.py</code></td>
<td style="text-align: right;">1.40s</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>pandoc MANUAL.txt --lua-filter ./smallcaps.lua</code></td>
<td style="text-align: right;">1.03s</td>
</tr>
</tbody>
</table>
<p>As you can see, the lua filter avoids the substantial overhead associated with marshalling to and from JSON over a pipe.</p>
<h1 id="lua-filter-structure">Lua filter structure</h1>
<p>Lua filters are tables with element names as keys and values consisting of functions acting on those elements.</p>
<p>Filters are expected to be put into separate files and are passed via the <code>--lua-filter</code> command-line argument. For example, if a filter is defined in a file <code>current-date.lua</code>, then it would be applied like this:</p>
<pre><code>pandoc --lua-filter=current-date.lua -f markdown MANUAL.txt</code></pre>
<p>The <code>--lua-filter</code> option may be supplied multiple times. Pandoc applies all filters (including JSON filters specified via <code>--filter</code> and lua filters specified via <code>--lua-filter</code>) in the order they appear on the command line.</p>
<p>Pandoc expects each lua file to return a list of filters. The filters in that list are called sequentially, each on the result of the previous filter. If there is no value returned by the filter script, then pandoc will try to generate a single filter by collecting all top-level functions whose names correspond to those of pandoc elements (e.g., <code>Str</code>, <code>Para</code>, <code>Meta</code>, or <code>Pandoc</code>). (That is why the two examples above are equivalent.)</p>
<p>For each filter, the document is traversed and each element subjected to the filter. Elements for which the filter contains an entry (i.e. a function of the same name) are passed to lua element filtering function. In other words, filter entries will be called for each corresponding element in the document, getting the respective element as input.</p>
<p>The return of a filter function must one of the following:</p>
<ul>
<li>nil: this means that the object should remain unchanged.</li>
<li>a pandoc object: this must be of the same type as the input and will replace the original object.</li>
<li>a list of pandoc objects: these will replace the original object; the list is merged with the neighbors of the orignal objects (spliced into the list the original object belongs to); returning an empty list deletes the object.</li>
</ul>
<p>The function’s output must result in an element of the same type as the input. This means a filter function acting on an inline element must return either nil, an inline, or a list of inlines, and a function filtering a block element must return one of nil, a block, or a list of block elements. Pandoc will throw an error if this condition is violated.</p>
<p>If there is no function matching the element’s node type, then the filtering system will look for a more general fallback function. Two fallback functions are supported, <code>Inline</code> and <code>Block</code>. Each matches elements of the respective type.</p>
<p>Elements without matching functions are left untouched.</p>
<p>See <a href="#module-pandoc">module documentation</a> for a list of pandoc elements.</p>
<p>The global <code>FORMAT</code> is set to the format of the pandoc writer being used (<code>html5</code>, <code>latex</code>, etc.), so the behavior of a filter can be made conditional on the eventual output format.</p>
<h1 id="pandoc-module">Pandoc Module</h1>
<p>The <code>pandoc</code> lua module is loaded into the filter’s lua environment and provides a set of functions and constants to make creation and manipulation of elements easier. The global variable <code>pandoc</code> is bound to the module and should generally not be overwritten for this reason.</p>
<p>Two major functionalities are provided by the module: element creator functions and access to some of pandoc’s main functionalities.</p>
<h2 id="element-creation">Element creation</h2>
<p>Element creator functions like <code>Str</code>, <code>Para</code>, and <code>Pandoc</code> are designed to allow easy creation of new elements that are simple to use and can be read back from the lua environment. Internally, pandoc uses these functions to create the lua objects which are passed to element filter functions. This means that elements created via this module will behave exactly as those elements accessible through the filter function parameter.</p>
<h2 id="exposed-pandoc-functionality">Exposed pandoc functionality</h2>
<p>Some pandoc functions have been made available in lua:</p>
<ul>
<li><a href="#walk_block"><code>walk_block</code></a> and <a href="#walk_inline"><code>walk_inline</code></a> allow filters to be applied inside specific block or inline elements;</li>
<li><a href="#read"><code>read</code></a> allows filters to parse strings into pandoc documents;</li>
<li><a href="#pipe"><code>pipe</code></a> runs an external command with input from and output to strings;</li>
<li>the <a href="#module-pandoc.mediabag"><code>pandoc.mediabag</code></a> module allows access to the “mediabag,” which stores binary content such as images that may be included in the final document;</li>
<li>the <a href="#module-pandoc.utils"><code>pandoc.utils</code></a> module contains various utility functions.</li>
</ul>
<h1 id="lua-interpreter-initialization">Lua interpreter initialization</h1>
<p>The way the Lua interpreter is set-up can be controlled by placing a file <code>init.lua</code> in pandoc’s data directory. The default init file loads the <code>pandoc</code> and <code>pandoc.mediabag</code> modules:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb4-1" data-line-number="1">pandoc <span class="ot">=</span> <span class="fu">require</span> <span class="st">&#39;pandoc&#39;</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">pandoc<span class="ot">.</span>mediabag <span class="ot">=</span> <span class="fu">require</span> <span class="st">&#39;pandoc.mediabag&#39;</span></a></code></pre></div>
<p>A common use-case would be to add code to load additional modules or to alter default modules. E.g., the following snippet adds all unicode-aware functions defined in the <a href="#module-text"><code>text</code> module</a> to the default <code>string</code> module, prefixed with the string <code>uc_</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">for</span> name<span class="ot">,</span> fn <span class="kw">in</span> <span class="fu">pairs</span><span class="ot">(</span><span class="fu">require</span> <span class="st">&#39;text&#39;</span><span class="ot">)</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  string<span class="ot">[</span><span class="st">&#39;uc_&#39;</span> <span class="ot">..</span> name<span class="ot">]</span> <span class="ot">=</span> fn</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw">end</span></a></code></pre></div>
<p>This makes it possible to apply these functions on strings using colon syntax (<code>mystring:uc_upper()</code>).</p>
<h1 id="examples">Examples</h1>
<h2 id="macro-substitution.">Macro substitution.</h2>
<p>The following filter converts the string <code>{{helloworld}}</code> into emphasized text “Hello, World”.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">return</span> <span class="ot">{</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="ot">{</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    Str <span class="ot">=</span> <span class="kw">function</span> <span class="ot">(</span>elem<span class="ot">)</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">      <span class="kw">if</span> elem<span class="ot">.</span>text <span class="ot">==</span> <span class="st">&quot;{{helloworld}}&quot;</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">        <span class="kw">return</span> pandoc<span class="ot">.</span>Emph <span class="ot">{</span>pandoc<span class="ot">.</span>Str <span class="st">&quot;Hello, World&quot;</span><span class="ot">}</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">      <span class="kw">else</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">        <span class="kw">return</span> elem</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">      <span class="kw">end</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    <span class="kw">end</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">  <span class="ot">}</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="ot">}</span></a></code></pre></div>
<h2 id="default-metadata-file">Default metadata file</h2>
<p>This filter causes metadata defined in an external file (<code>metadata-file.yaml</code>) to be used as default values in a document’s metadata:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="do">-- read metadata file into string</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw">local</span> metafile <span class="ot">=</span> <span class="fu">io.open</span><span class="ot">(</span><span class="st">&#39;metadata-file.yaml&#39;</span><span class="ot">,</span> <span class="st">&#39;r&#39;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw">local</span> content <span class="ot">=</span> metafile:<span class="fu">read</span><span class="ot">(</span><span class="st">&quot;*a&quot;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">metafile:<span class="fu">close</span><span class="ot">()</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="do">-- get metadata</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="kw">local</span> default_meta <span class="ot">=</span> pandoc<span class="ot">.</span>read<span class="ot">(</span>content<span class="ot">,</span> <span class="st">&quot;markdown&quot;</span><span class="ot">).</span>meta</a>
<a class="sourceLine" id="cb7-7" data-line-number="7"></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="kw">return</span> <span class="ot">{</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">  <span class="ot">{</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10">    Meta <span class="ot">=</span> <span class="kw">function</span><span class="ot">(</span>meta<span class="ot">)</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11">      <span class="do">-- use default metadata field if it hasn&#39;t been defined yet.</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12">      <span class="kw">for</span> k<span class="ot">,</span> v <span class="kw">in</span> <span class="fu">pairs</span><span class="ot">(</span>default_meta<span class="ot">)</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">        <span class="kw">if</span> meta<span class="ot">[</span>k<span class="ot">]</span> <span class="ot">==</span> <span class="kw">nil</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">          meta<span class="ot">[</span>k<span class="ot">]</span> <span class="ot">=</span> v</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">        <span class="kw">end</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16">      <span class="kw">end</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17">      <span class="kw">return</span> meta</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">    <span class="kw">end</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19">  <span class="ot">}</span></a></code></pre></div>
<h2 id="setting-the-date-in-the-metadata">Setting the date in the metadata</h2>
<p>This filter sets the date in the document’s metadata to the current date:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">function</span> Meta<span class="ot">(</span>m<span class="ot">)</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  m<span class="ot">.</span>date <span class="ot">=</span> <span class="fu">os.date</span><span class="ot">(</span><span class="st">&quot;%B %e, %Y&quot;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="kw">return</span> m</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="kw">end</span></a></code></pre></div>
<h2 id="extracting-information-about-links">Extracting information about links</h2>
<p>This filter prints a table of all the URLs linked to in the document, together with the number of links to that URL.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb9-1" data-line-number="1">links <span class="ot">=</span> <span class="ot">{}</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw">function</span> Link <span class="ot">(</span>el<span class="ot">)</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">  <span class="kw">if</span> links<span class="ot">[</span>el<span class="ot">.</span>target<span class="ot">]</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">    links<span class="ot">[</span>el<span class="ot">.</span>target<span class="ot">]</span> <span class="ot">=</span> links<span class="ot">[</span>el<span class="ot">.</span>target<span class="ot">]</span> <span class="ot">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  <span class="kw">else</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">    links<span class="ot">[</span>el<span class="ot">.</span>target<span class="ot">]</span> <span class="ot">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9">  <span class="kw">return</span> el</a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="kw">end</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="kw">function</span> Doc <span class="ot">(</span>blocks<span class="ot">,</span> meta<span class="ot">)</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">  <span class="kw">function</span> strCell<span class="ot">(</span>str<span class="ot">)</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14">    <span class="kw">return</span> <span class="ot">{</span>pandoc<span class="ot">.</span>Plain<span class="ot">{</span>pandoc<span class="ot">.</span>Str<span class="ot">(</span>str<span class="ot">)}}</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16">  <span class="kw">local</span> caption <span class="ot">=</span> <span class="ot">{</span>pandoc<span class="ot">.</span>Str <span class="st">&quot;Link&quot;</span><span class="ot">,</span> pandoc<span class="ot">.</span>Space<span class="ot">(),</span> pandoc<span class="ot">.</span>Str <span class="st">&quot;count&quot;</span><span class="ot">}</span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17">  <span class="kw">local</span> aligns <span class="ot">=</span> <span class="ot">{</span>pandoc<span class="ot">.</span>AlignDefault<span class="ot">,</span> pandoc<span class="ot">.</span>AlignLeft<span class="ot">}</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18">  <span class="kw">local</span> widths <span class="ot">=</span> <span class="ot">{</span><span class="dv">0.8</span><span class="ot">,</span> <span class="dv">0.2</span><span class="ot">}</span></a>
<a class="sourceLine" id="cb9-19" data-line-number="19">  <span class="kw">local</span> headers <span class="ot">=</span> <span class="ot">{</span>strCell <span class="st">&quot;Target&quot;</span><span class="ot">,</span> strCell <span class="st">&quot;Count&quot;</span><span class="ot">}</span></a>
<a class="sourceLine" id="cb9-20" data-line-number="20">  <span class="kw">local</span> rows <span class="ot">=</span> <span class="ot">{}</span></a>
<a class="sourceLine" id="cb9-21" data-line-number="21">  <span class="kw">for</span> link<span class="ot">,</span> count <span class="kw">in</span> <span class="fu">pairs</span><span class="ot">(</span>links<span class="ot">)</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-22" data-line-number="22">    rows<span class="ot">[#</span>rows <span class="ot">+</span> <span class="dv">1</span><span class="ot">]</span> <span class="ot">=</span> <span class="ot">{</span>strCell<span class="ot">(</span>link<span class="ot">),</span> strCell<span class="ot">(</span>count<span class="ot">)}</span></a>
<a class="sourceLine" id="cb9-23" data-line-number="23">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb9-24" data-line-number="24">  <span class="kw">return</span> pandoc<span class="ot">.</span>Doc<span class="ot">(</span></a>
<a class="sourceLine" id="cb9-25" data-line-number="25">    <span class="ot">{</span>pandoc<span class="ot">.</span>Table<span class="ot">(</span>caption<span class="ot">,</span> aligns<span class="ot">,</span> widths<span class="ot">,</span> headers<span class="ot">,</span> rows<span class="ot">)},</span></a>
<a class="sourceLine" id="cb9-26" data-line-number="26">    meta</a>
<a class="sourceLine" id="cb9-27" data-line-number="27">  <span class="ot">)</span></a>
<a class="sourceLine" id="cb9-28" data-line-number="28"><span class="kw">end</span></a></code></pre></div>
<h2 id="replacing-placeholders-with-their-metadata-value">Replacing placeholders with their metadata value</h2>
<p>Lua filter functions are run in the order</p>
<blockquote>
<p><em>Inlines → Blocks → Meta → Pandoc</em>.</p>
</blockquote>
<p>Passing information from a higher level (e.g., metadata) to a lower level (e.g., inlines) is still possible by using two filters living in the same file:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">local</span> vars <span class="ot">=</span> <span class="ot">{}</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="kw">function</span> get_vars <span class="ot">(</span>meta<span class="ot">)</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">  <span class="kw">for</span> k<span class="ot">,</span> v <span class="kw">in</span> <span class="fu">pairs</span><span class="ot">(</span>meta<span class="ot">)</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">    <span class="kw">if</span> v<span class="ot">.</span>t <span class="ot">==</span> <span class="st">&#39;MetaInlines&#39;</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">      vars<span class="ot">[</span><span class="st">&quot;$&quot;</span> <span class="ot">..</span> k <span class="ot">..</span> <span class="st">&quot;$&quot;</span><span class="ot">]</span> <span class="ot">=</span> v</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="kw">end</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="kw">function</span> replace <span class="ot">(</span>el<span class="ot">)</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">  <span class="kw">if</span> vars<span class="ot">[</span>el<span class="ot">.</span>text<span class="ot">]</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13">    <span class="kw">return</span> pandoc<span class="ot">.</span>Span<span class="ot">(</span>vars<span class="ot">[</span>el<span class="ot">.</span>text<span class="ot">])</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14">  <span class="kw">else</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15">    <span class="kw">return</span> el</a>
<a class="sourceLine" id="cb10-16" data-line-number="16">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="kw">end</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18"></a>
<a class="sourceLine" id="cb10-19" data-line-number="19"><span class="kw">return</span> <span class="ot">{{</span>Meta <span class="ot">=</span> get_vars<span class="ot">},</span> <span class="ot">{</span>Str <span class="ot">=</span> replace<span class="ot">}}</span></a></code></pre></div>
<p>If the contents of file <code>occupations.md</code> is</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode markdown"><code class="sourceCode markdown"><a class="sourceLine" id="cb11-1" data-line-number="1">---</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">name: Samuel Q. Smith</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">occupation: Professor of Phrenology</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">---</a>
<a class="sourceLine" id="cb11-5" data-line-number="5"></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">Name</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">: \$name\$</a>
<a class="sourceLine" id="cb11-9" data-line-number="9"></a>
<a class="sourceLine" id="cb11-10" data-line-number="10">Occupation</a>
<a class="sourceLine" id="cb11-11" data-line-number="11"></a>
<a class="sourceLine" id="cb11-12" data-line-number="12">: \$occupation\$</a></code></pre></div>
<p>then running <code>pandoc --lua-filter=meta-vars.lua occupations.md</code> will output:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">&lt;dl&gt;</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="kw">&lt;dt&gt;</span>Name<span class="kw">&lt;/dt&gt;</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="kw">&lt;dd&gt;&lt;p&gt;&lt;span&gt;</span>Samuel Q. Smith<span class="kw">&lt;/span&gt;&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="kw">&lt;/dd&gt;</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="kw">&lt;dt&gt;</span>Occupation<span class="kw">&lt;/dt&gt;</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="kw">&lt;dd&gt;&lt;p&gt;&lt;span&gt;</span>Professor of Phrenology<span class="kw">&lt;/span&gt;&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="kw">&lt;/dd&gt;</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="kw">&lt;/dl&gt;</span></a></code></pre></div>
<h2 id="modifying-pandocs-manual.txt-for-man-pages">Modifying pandoc’s <code>MANUAL.txt</code> for man pages</h2>
<p>This is the filter we use when converting <code>MANUAL.txt</code> to man pages. It converts level-1 headers to uppercase (using <code>walk_block</code> to transform inline elements inside headers), removes footnotes, and replaces links with regular text.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="do">-- we use preloaded text to get a UTF-8 aware &#39;upper&#39; function</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw">local</span> text <span class="ot">=</span> <span class="fu">require</span><span class="ot">(</span><span class="st">&#39;text&#39;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="kw">function</span> Header<span class="ot">(</span>el<span class="ot">)</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">    <span class="kw">if</span> el<span class="ot">.</span>level <span class="ot">==</span> <span class="dv">1</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">      <span class="kw">return</span> pandoc<span class="ot">.</span>walk_block<span class="ot">(</span>el<span class="ot">,</span> <span class="ot">{</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">        Str <span class="ot">=</span> <span class="kw">function</span><span class="ot">(</span>el<span class="ot">)</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">            <span class="kw">return</span> pandoc<span class="ot">.</span>Str<span class="ot">(</span>text<span class="ot">.</span>upper<span class="ot">(</span>el<span class="ot">.</span>text<span class="ot">))</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9">        <span class="kw">end</span> <span class="ot">})</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="kw">end</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="kw">function</span> Link<span class="ot">(</span>el<span class="ot">)</span></a>
<a class="sourceLine" id="cb13-14" data-line-number="14">    <span class="kw">return</span> el<span class="ot">.</span>content</a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="kw">end</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"></a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="kw">function</span> Note<span class="ot">(</span>el<span class="ot">)</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18">    <span class="kw">return</span> <span class="ot">{}</span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19"><span class="kw">end</span></a></code></pre></div>
<h2 id="creating-a-handout-from-a-paper">Creating a handout from a paper</h2>
<p>This filter extracts all the numbered examples, section headers, block quotes, and figures from a document, in addition to any divs with class <code>handout</code>. (Note that only blocks at the “outer level” are included; this ignores blocks inside nested constructs, like list items.)</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="do">-- creates a handout from an article, using its headings,</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="do">-- blockquotes, numbered examples, figures, and any</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="do">-- Divs with class &quot;handout&quot;</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="kw">function</span> Pandoc<span class="ot">(</span>doc<span class="ot">)</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6">    <span class="kw">local</span> hblocks <span class="ot">=</span> <span class="ot">{}</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7">    <span class="kw">for</span> i<span class="ot">,</span>el <span class="kw">in</span> <span class="fu">pairs</span><span class="ot">(</span>doc<span class="ot">.</span>blocks<span class="ot">)</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8">        <span class="kw">if</span> <span class="ot">(</span>el<span class="ot">.</span>t <span class="ot">==</span> <span class="st">&quot;Div&quot;</span> <span class="kw">and</span> el<span class="ot">.</span>classes<span class="ot">[</span><span class="dv">1</span><span class="ot">]</span> <span class="ot">==</span> <span class="st">&quot;handout&quot;</span><span class="ot">)</span> <span class="kw">or</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9">           <span class="ot">(</span>el<span class="ot">.</span>t <span class="ot">==</span> <span class="st">&quot;BlockQuote&quot;</span><span class="ot">)</span> <span class="kw">or</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10">           <span class="ot">(</span>el<span class="ot">.</span>t <span class="ot">==</span> <span class="st">&quot;OrderedList&quot;</span> <span class="kw">and</span> el<span class="ot">.</span>style <span class="ot">==</span> <span class="st">&quot;Example&quot;</span><span class="ot">)</span> <span class="kw">or</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11">           <span class="ot">(</span>el<span class="ot">.</span>t <span class="ot">==</span> <span class="st">&quot;Para&quot;</span> <span class="kw">and</span> <span class="ot">#</span>el<span class="ot">.</span>c <span class="ot">==</span> <span class="dv">1</span> <span class="kw">and</span> el<span class="ot">.</span>c<span class="ot">[</span><span class="dv">1</span><span class="ot">].</span>t <span class="ot">==</span> <span class="st">&quot;Image&quot;</span><span class="ot">)</span> <span class="kw">or</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12">           <span class="ot">(</span>el<span class="ot">.</span>t <span class="ot">==</span> <span class="st">&quot;Header&quot;</span><span class="ot">)</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb14-13" data-line-number="13">           <span class="fu">table.insert</span><span class="ot">(</span>hblocks<span class="ot">,</span> el<span class="ot">)</span></a>
<a class="sourceLine" id="cb14-14" data-line-number="14">        <span class="kw">end</span></a>
<a class="sourceLine" id="cb14-15" data-line-number="15">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16">    <span class="kw">return</span> pandoc<span class="ot">.</span>Pandoc<span class="ot">(</span>hblocks<span class="ot">,</span> doc<span class="ot">.</span>meta<span class="ot">)</span></a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="kw">end</span></a></code></pre></div>
<h2 id="counting-words-in-a-document">Counting words in a document</h2>
<p>This filter counts the words in the body of a document (omitting metadata like titles and abstracts), including words in code. It should be more accurate than <code>wc -w</code> run directly on a Markdown document, since the latter will count markup characters, like the <code>#</code> in front of an ATX header, or tags in HTML documents, as words. To run it, <code>pandoc --lua-filter wordcount.lua myfile.md</code>.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="do">-- counts words in a document</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"></a>
<a class="sourceLine" id="cb15-3" data-line-number="3">words <span class="ot">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"></a>
<a class="sourceLine" id="cb15-5" data-line-number="5">wordcount <span class="ot">=</span> <span class="ot">{</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">  Str <span class="ot">=</span> <span class="kw">function</span><span class="ot">(</span>el<span class="ot">)</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7">    <span class="do">-- we don&#39;t count a word if it&#39;s entirely punctuation:</span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8">    <span class="kw">if</span> el<span class="ot">.</span>text:match<span class="ot">(</span><span class="st">&quot;%P&quot;</span><span class="ot">)</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9">        words <span class="ot">=</span> words <span class="ot">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11">  <span class="kw">end</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb15-12" data-line-number="12"></a>
<a class="sourceLine" id="cb15-13" data-line-number="13">  Code <span class="ot">=</span> <span class="kw">function</span><span class="ot">(</span>el<span class="ot">)</span></a>
<a class="sourceLine" id="cb15-14" data-line-number="14">    _<span class="ot">,</span>n <span class="ot">=</span> el<span class="ot">.</span>text:<span class="fu">gsub</span><span class="ot">(</span><span class="st">&quot;%S+&quot;</span><span class="ot">,</span><span class="st">&quot;&quot;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb15-15" data-line-number="15">    words <span class="ot">=</span> words <span class="ot">+</span> n</a>
<a class="sourceLine" id="cb15-16" data-line-number="16">  <span class="kw">end</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb15-17" data-line-number="17"></a>
<a class="sourceLine" id="cb15-18" data-line-number="18">  CodeBlock <span class="ot">=</span> <span class="kw">function</span><span class="ot">(</span>el<span class="ot">)</span></a>
<a class="sourceLine" id="cb15-19" data-line-number="19">    _<span class="ot">,</span>n <span class="ot">=</span> el<span class="ot">.</span>text:<span class="fu">gsub</span><span class="ot">(</span><span class="st">&quot;%S+&quot;</span><span class="ot">,</span><span class="st">&quot;&quot;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb15-20" data-line-number="20">    words <span class="ot">=</span> words <span class="ot">+</span> n</a>
<a class="sourceLine" id="cb15-21" data-line-number="21">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb15-22" data-line-number="22"><span class="ot">}</span></a>
<a class="sourceLine" id="cb15-23" data-line-number="23"></a>
<a class="sourceLine" id="cb15-24" data-line-number="24"><span class="kw">function</span> Pandoc<span class="ot">(</span>el<span class="ot">)</span></a>
<a class="sourceLine" id="cb15-25" data-line-number="25">    <span class="do">-- skip metadata, just count body:</span></a>
<a class="sourceLine" id="cb15-26" data-line-number="26">    pandoc<span class="ot">.</span>walk_block<span class="ot">(</span>pandoc<span class="ot">.</span>Div<span class="ot">(</span>el<span class="ot">.</span>blocks<span class="ot">),</span> wordcount<span class="ot">)</span></a>
<a class="sourceLine" id="cb15-27" data-line-number="27">    <span class="fu">print</span><span class="ot">(</span>words <span class="ot">..</span> <span class="st">&quot; words in body&quot;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb15-28" data-line-number="28">    <span class="fu">os.exit</span><span class="ot">(</span><span class="dv">0</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb15-29" data-line-number="29"><span class="kw">end</span></a></code></pre></div>
<h2 id="converting-abc-code-to-music-notation">Converting ABC code to music notation</h2>
<p>This filter replaces code blocks with class <code>abc</code> with images created by running their contents through <code>abcm2ps</code> and ImageMagick’s <code>convert</code>. (For more on ABC notation, see <a href="http://abcnotation.com" class="uri">http://abcnotation.com</a>.)</p>
<p>Images are added to the mediabag. For output to binary formats, pandoc will use images in the mediabag. For textual formats, use <code>--extract-media</code> to specify a directory where the files in the mediabag will be written, or (for HTML only) use <code>--self-contained</code>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="do">-- Pandoc filter to process code blocks with class &quot;abc&quot; containing</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="do">-- ABC notation into images.</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="do">--</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="do">-- * Assumes that abcm2ps and ImageMagick&#39;s convert are in the path.</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="do">-- * For textual output formats, use --extract-media=abc-images</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="do">-- * For HTML formats, you may alternatively use --self-contained</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="kw">local</span> filetypes <span class="ot">=</span> <span class="ot">{</span> html <span class="ot">=</span> <span class="ot">{</span><span class="st">&quot;png&quot;</span><span class="ot">,</span> <span class="st">&quot;image/png&quot;</span><span class="ot">}</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9">                  <span class="ot">,</span> latex <span class="ot">=</span> <span class="ot">{</span><span class="st">&quot;pdf&quot;</span><span class="ot">,</span> <span class="st">&quot;application/pdf&quot;</span><span class="ot">}</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10">                  <span class="ot">}</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11"><span class="kw">local</span> filetype <span class="ot">=</span> filetypes<span class="ot">[</span>FORMAT<span class="ot">][</span><span class="dv">1</span><span class="ot">]</span> <span class="kw">or</span> <span class="st">&quot;png&quot;</span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"><span class="kw">local</span> mimetype <span class="ot">=</span> filetypes<span class="ot">[</span>FORMAT<span class="ot">][</span><span class="dv">2</span><span class="ot">]</span> <span class="kw">or</span> <span class="st">&quot;image/png&quot;</span></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"></a>
<a class="sourceLine" id="cb16-14" data-line-number="14"><span class="kw">local</span> <span class="kw">function</span> abc2eps<span class="ot">(</span>abc<span class="ot">,</span> filetype<span class="ot">)</span></a>
<a class="sourceLine" id="cb16-15" data-line-number="15">    <span class="kw">local</span> eps <span class="ot">=</span> pandoc<span class="ot">.</span>pipe<span class="ot">(</span><span class="st">&quot;abcm2ps&quot;</span><span class="ot">,</span> <span class="ot">{</span><span class="st">&quot;-q&quot;</span><span class="ot">,</span> <span class="st">&quot;-O&quot;</span><span class="ot">,</span> <span class="st">&quot;-&quot;</span><span class="ot">,</span> <span class="st">&quot;-&quot;</span><span class="ot">},</span> abc<span class="ot">)</span></a>
<a class="sourceLine" id="cb16-16" data-line-number="16">    <span class="kw">local</span> final <span class="ot">=</span> pandoc<span class="ot">.</span>pipe<span class="ot">(</span><span class="st">&quot;convert&quot;</span><span class="ot">,</span> <span class="ot">{</span><span class="st">&quot;-&quot;</span><span class="ot">,</span> filetype <span class="ot">..</span> <span class="st">&quot;:-&quot;</span><span class="ot">},</span> eps<span class="ot">)</span></a>
<a class="sourceLine" id="cb16-17" data-line-number="17">    <span class="kw">return</span> final</a>
<a class="sourceLine" id="cb16-18" data-line-number="18"><span class="kw">end</span></a>
<a class="sourceLine" id="cb16-19" data-line-number="19"></a>
<a class="sourceLine" id="cb16-20" data-line-number="20"><span class="kw">function</span> CodeBlock<span class="ot">(</span>block<span class="ot">)</span></a>
<a class="sourceLine" id="cb16-21" data-line-number="21">    <span class="kw">if</span> block<span class="ot">.</span>classes<span class="ot">[</span><span class="dv">1</span><span class="ot">]</span> <span class="ot">==</span> <span class="st">&quot;abc&quot;</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb16-22" data-line-number="22">        <span class="kw">local</span> img <span class="ot">=</span> abc2eps<span class="ot">(</span>block<span class="ot">.</span>text<span class="ot">,</span> filetype<span class="ot">)</span></a>
<a class="sourceLine" id="cb16-23" data-line-number="23">        <span class="kw">local</span> fname <span class="ot">=</span> pandoc<span class="ot">.</span>sha1<span class="ot">(</span>img<span class="ot">)</span> <span class="ot">..</span> <span class="st">&quot;.&quot;</span> <span class="ot">..</span> filetype</a>
<a class="sourceLine" id="cb16-24" data-line-number="24">        pandoc<span class="ot">.</span>mediabag<span class="ot">.</span>insert<span class="ot">(</span>fname<span class="ot">,</span> mimetype<span class="ot">,</span> img<span class="ot">)</span></a>
<a class="sourceLine" id="cb16-25" data-line-number="25">        <span class="kw">return</span> pandoc<span class="ot">.</span>Para<span class="ot">{</span> pandoc<span class="ot">.</span>Image<span class="ot">({</span>pandoc<span class="ot">.</span>Str<span class="ot">(</span><span class="st">&quot;abc tune&quot;</span><span class="ot">)},</span> fname<span class="ot">)</span> <span class="ot">}</span></a>
<a class="sourceLine" id="cb16-26" data-line-number="26">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb16-27" data-line-number="27"><span class="kw">end</span></a></code></pre></div>
<h2 id="building-images-with-tikz">Building images with tikz</h2>
<p>This filter converts raw LaTeX tikz environments into images. It works with both PDF and HTML output. The tikz code is compiled to an image using <code>pdflatex</code>, and the image is converted (if necessary) from pdf to png format using ImageMagick’s <code>convert</code>, so both of these must be in the system path. Converted images are cached in the working directory and given filenames based on a hash of the source, so that they need not be regenerated each time the document is built. (A more sophisticated version of this might put these in a special cache directory.)</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">local</span> <span class="kw">function</span> tikz2image<span class="ot">(</span>src<span class="ot">,</span> filetype<span class="ot">,</span> outfile<span class="ot">)</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">    <span class="kw">local</span> tmp <span class="ot">=</span> <span class="fu">os.tmpname</span><span class="ot">()</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3">    <span class="kw">local</span> tmpdir <span class="ot">=</span> string<span class="ot">.</span>match<span class="ot">(</span>tmp<span class="ot">,</span> <span class="st">&quot;^(.*[</span><span class="ot">\\</span><span class="st">/])&quot;</span><span class="ot">)</span> <span class="kw">or</span> <span class="st">&quot;.&quot;</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">    <span class="kw">local</span> f <span class="ot">=</span> <span class="fu">io.open</span><span class="ot">(</span>tmp <span class="ot">..</span> <span class="st">&quot;.tex&quot;</span><span class="ot">,</span> <span class="st">&#39;w&#39;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5">    f:<span class="fu">write</span><span class="ot">(</span><span class="st">&quot;</span><span class="ot">\\</span><span class="st">documentclass{standalone}</span><span class="ot">\n\\</span><span class="st">usepackage{tikz}</span><span class="ot">\n\\</span><span class="st">begin{document}</span><span class="ot">\n</span><span class="st">&quot;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6">    f:<span class="fu">write</span><span class="ot">(</span>src<span class="ot">)</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7">    f:<span class="fu">write</span><span class="ot">(</span><span class="st">&quot;</span><span class="ot">\n\\</span><span class="st">end{document}</span><span class="ot">\n</span><span class="st">&quot;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8">    f:<span class="fu">close</span><span class="ot">()</span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9">    <span class="fu">os.execute</span><span class="ot">(</span><span class="st">&quot;pdflatex -output-directory &quot;</span> <span class="ot">..</span> tmpdir  <span class="ot">..</span> <span class="st">&quot; &quot;</span> <span class="ot">..</span> tmp<span class="ot">)</span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10">    <span class="kw">if</span> filetype <span class="ot">==</span> <span class="st">&#39;pdf&#39;</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb17-11" data-line-number="11">        <span class="fu">os.rename</span><span class="ot">(</span>tmp <span class="ot">..</span> <span class="st">&quot;.pdf&quot;</span><span class="ot">,</span> outfile<span class="ot">)</span></a>
<a class="sourceLine" id="cb17-12" data-line-number="12">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb17-13" data-line-number="13">        <span class="fu">os.execute</span><span class="ot">(</span><span class="st">&quot;convert &quot;</span> <span class="ot">..</span> tmp <span class="ot">..</span> <span class="st">&quot;.pdf &quot;</span> <span class="ot">..</span> outfile<span class="ot">)</span></a>
<a class="sourceLine" id="cb17-14" data-line-number="14">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb17-15" data-line-number="15">    <span class="fu">os.remove</span><span class="ot">(</span>tmp <span class="ot">..</span> <span class="st">&quot;.tex&quot;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb17-16" data-line-number="16">    <span class="fu">os.remove</span><span class="ot">(</span>tmp <span class="ot">..</span> <span class="st">&quot;.pdf&quot;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb17-17" data-line-number="17">    <span class="fu">os.remove</span><span class="ot">(</span>tmp <span class="ot">..</span> <span class="st">&quot;.log&quot;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb17-18" data-line-number="18">    <span class="fu">os.remove</span><span class="ot">(</span>tmp <span class="ot">..</span> <span class="st">&quot;.aux&quot;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb17-19" data-line-number="19"><span class="kw">end</span></a>
<a class="sourceLine" id="cb17-20" data-line-number="20"></a>
<a class="sourceLine" id="cb17-21" data-line-number="21">extension_for <span class="ot">=</span> <span class="ot">{</span></a>
<a class="sourceLine" id="cb17-22" data-line-number="22">    html <span class="ot">=</span> <span class="st">&#39;png&#39;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb17-23" data-line-number="23">    html4 <span class="ot">=</span> <span class="st">&#39;png&#39;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb17-24" data-line-number="24">    html5 <span class="ot">=</span> <span class="st">&#39;png&#39;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb17-25" data-line-number="25">    latex <span class="ot">=</span> <span class="st">&#39;pdf&#39;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb17-26" data-line-number="26">    beamer <span class="ot">=</span> <span class="st">&#39;pdf&#39;</span> <span class="ot">}</span></a>
<a class="sourceLine" id="cb17-27" data-line-number="27"></a>
<a class="sourceLine" id="cb17-28" data-line-number="28"><span class="kw">local</span> <span class="kw">function</span> file_exists<span class="ot">(</span>name<span class="ot">)</span></a>
<a class="sourceLine" id="cb17-29" data-line-number="29">    <span class="kw">local</span> f <span class="ot">=</span> <span class="fu">io.open</span><span class="ot">(</span>name<span class="ot">,</span> <span class="st">&#39;r&#39;</span><span class="ot">)</span></a>
<a class="sourceLine" id="cb17-30" data-line-number="30">    <span class="kw">if</span> f <span class="ot">~=</span> <span class="kw">nil</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb17-31" data-line-number="31">        <span class="fu">io.close</span><span class="ot">(</span>f<span class="ot">)</span></a>
<a class="sourceLine" id="cb17-32" data-line-number="32">        <span class="kw">return</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb17-33" data-line-number="33">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb17-34" data-line-number="34">        <span class="kw">return</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb17-35" data-line-number="35">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb17-36" data-line-number="36"><span class="kw">end</span></a>
<a class="sourceLine" id="cb17-37" data-line-number="37"></a>
<a class="sourceLine" id="cb17-38" data-line-number="38"><span class="kw">function</span> RawBlock<span class="ot">(</span>el<span class="ot">)</span></a>
<a class="sourceLine" id="cb17-39" data-line-number="39">    <span class="kw">local</span> filetype <span class="ot">=</span> extension_for<span class="ot">[</span>FORMAT<span class="ot">]</span> <span class="kw">or</span> <span class="st">&quot;png&quot;</span></a>
<a class="sourceLine" id="cb17-40" data-line-number="40">    <span class="kw">local</span> fname <span class="ot">=</span> pandoc<span class="ot">.</span>sha1<span class="ot">(</span>el<span class="ot">.</span>text<span class="ot">)</span> <span class="ot">..</span> <span class="st">&quot;.&quot;</span> <span class="ot">..</span> filetype</a>
<a class="sourceLine" id="cb17-41" data-line-number="41">    <span class="kw">if</span> <span class="kw">not</span> file_exists<span class="ot">(</span>fname<span class="ot">)</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb17-42" data-line-number="42">        tikz2image<span class="ot">(</span>el<span class="ot">.</span>text<span class="ot">,</span> filetype<span class="ot">,</span> fname<span class="ot">)</span></a>
<a class="sourceLine" id="cb17-43" data-line-number="43">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb17-44" data-line-number="44">    <span class="kw">return</span> pandoc<span class="ot">.</span>Para<span class="ot">({</span>pandoc<span class="ot">.</span>Image<span class="ot">({},</span> fname<span class="ot">)})</span></a>
<a class="sourceLine" id="cb17-45" data-line-number="45"><span class="kw">end</span></a></code></pre></div>
<p>Example of use:</p>
<pre><code>pandoc --lua-filter tikz.lua -s -o cycle.html &lt;&lt;EOF
Here is a diagram of the cycle:

\begin{tikzpicture}

\def \n {5}
\def \radius {3cm}
\def \margin {8} % margin in angles, depends on the radius

\foreach \s in {1,...,\n}
{
  \node[draw, circle] at ({360/\n * (\s - 1)}:\radius) {$\s$};
  \draw[-&gt;, &gt;=latex] ({360/\n * (\s - 1)+\margin}:\radius)
    arc ({360/\n * (\s - 1)+\margin}:{360/\n * (\s)-\margin}:\radius);
}
\end{tikzpicture}
EOF</code></pre>
<h1 id="module-text">Module text</h1>
<p>UTF-8 aware text manipulation functions, implemented in Haskell. These are available to any lua filter. However, the module must be explicitly loaded:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode lua"><code class="sourceCode lua"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="do">-- uppercase all regular text in a document:</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">text <span class="ot">=</span> <span class="fu">require</span> <span class="st">&#39;text&#39;</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="kw">function</span> Str <span class="ot">(</span>s<span class="ot">)</span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4">  s<span class="ot">.</span>text <span class="ot">=</span> text<span class="ot">.</span>upper<span class="ot">(</span>s<span class="ot">.</span>text<span class="ot">)</span></a>
<a class="sourceLine" id="cb19-5" data-line-number="5">  <span class="kw">return</span> s</a>
<a class="sourceLine" id="cb19-6" data-line-number="6"><span class="kw">end</span></a></code></pre></div>
<dl>
<dt><span id="text-lower"><code>lower (s)</code></span></dt>
<dd><p>Returns a copy of a UTF-8 string, converted to lowercase.</p>
</dd>
<dt><span id="text-upper"><code>upper (s)</code></span></dt>
<dd><p>Returns a copy of a UTF-8 string, converted to uppercase.</p>
</dd>
<dt><span id="text-reverse"><code>reverse (s)</code></span></dt>
<dd><p>Returns a copy of a UTF-8 string, with characters reversed.</p>
</dd>
<dt><span id="text-len"><code>len (s)</code></span></dt>
<dd><p>Returns the length of a UTF-8 string.</p>
</dd>
<dt><span id="text-sub"><code>sub (s)</code></span></dt>
<dd><p>Returns a substring of a UTF-8 string, using lua’s string indexing rules.</p>
</dd>
</dl>
<h1 id="module-pandoc">Module pandoc</h1>
<p>Lua functions for pandoc scripts.</p>
<h2 id="pandoc-document">Pandoc Document</h2>
<dl>
<dt><span id="Pandoc"><code>Pandoc (blocks[, meta])</code></span></dt>
<dd><p>A complete pandoc document</p>
<p>Parameters:</p>
<dl>
<dt><code>blocks</code>:</dt>
<dd>document content
</dd>
<dt><code>meta</code>:</dt>
<dd>document meta data
</dd>
</dl>
</dd>
</dl>
<h2 id="meta">Meta</h2>
<dl>
<dt><span id="Meta"><code>Meta (table)</code></span></dt>
<dd><p>Create a new Meta object.</p>
<p>Parameters:</p>
<dl>
<dt><code>table</code>:</dt>
<dd>table containing document meta information
</dd>
</dl>
</dd>
</dl>
<h2 id="metavalue">MetaValue</h2>
<dl>
<dt><span id="MetaBlocks"><code>MetaBlocks (blocks)</code></span></dt>
<dd><p>Meta blocks</p>
<p>Parameters:</p>
<dl>
<dt><code>blocks</code>:</dt>
<dd>blocks
</dd>
</dl>
</dd>
<dt><span id="MetaInlines"><code>MetaInlines (inlines)</code></span></dt>
<dd><p>Meta inlines</p>
<p>Parameters:</p>
<dl>
<dt><code>inlines</code>:</dt>
<dd>inlines
</dd>
</dl>
</dd>
<dt><span id="MetaList"><code>MetaList (meta_values)</code></span></dt>
<dd><p>Meta list</p>
<p>Parameters:</p>
<dl>
<dt><code>meta_values</code>:</dt>
<dd>list of meta values
</dd>
</dl>
</dd>
<dt><span id="MetaMap"><code>MetaMap (key_value_map)</code></span></dt>
<dd><p>Meta map</p>
<p>Parameters:</p>
<dl>
<dt><code>key_value_map</code>:</dt>
<dd>a string-indexed map of meta values
</dd>
</dl>
</dd>
<dt><span id="MetaString"><code>MetaString (str)</code></span></dt>
<dd><p>Creates string to be used in meta data.</p>
<p>Parameters:</p>
<dl>
<dt><code>str</code>:</dt>
<dd>string value
</dd>
</dl>
</dd>
<dt><span id="MetaBool"><code>MetaBool (bool)</code></span></dt>
<dd><p>Creates boolean to be used in meta data.</p>
<p>Parameters:</p>
<dl>
<dt><code>bool</code>:</dt>
<dd>boolean value
</dd>
</dl>
</dd>
</dl>
<h2 id="blocks">Blocks</h2>
<dl>
<dt><span id="Block"><code>Block</code></span></dt>
<dd><p>Block elements</p>
</dd>
<dt><span id="BlockQuote"><code>BlockQuote (content)</code></span></dt>
<dd><p>Creates a block quote element</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>block content
</dd>
</dl>
<p>Returns: block quote element</p>
</dd>
<dt><span id="BulletList"><code>BulletList (content)</code></span></dt>
<dd><p>Creates a bullet (i.e.</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>list of items
</dd>
</dl>
<p>Returns: bullet list element</p>
</dd>
<dt><span id="CodeBlock"><code>CodeBlock (text[, attr])</code></span></dt>
<dd><p>Creates a code block element</p>
<p>Parameters:</p>
<dl>
<dt><code>text</code>:</dt>
<dd>code string
</dd>
<dt><code>attr</code>:</dt>
<dd>element attributes
</dd>
</dl>
<p>Returns: code block element</p>
</dd>
<dt><span id="DefinitionList"><code>DefinitionList (content)</code></span></dt>
<dd><p>Creates a definition list, containing terms and their explanation.</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>list of items
</dd>
</dl>
<p>Returns: definition list element</p>
</dd>
<dt><span id="Div"><code>Div (content[, attr])</code></span></dt>
<dd><p>Creates a div element</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>block content
</dd>
<dt><code>attr</code>:</dt>
<dd>element attributes
</dd>
</dl>
<p>Returns: div element</p>
</dd>
<dt><span id="Header"><code>Header (level, content[, attr])</code></span></dt>
<dd><p>Creates a header element.</p>
<p>Parameters:</p>
<dl>
<dt><code>level</code>:</dt>
<dd>header level
</dd>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
<dt><code>attr</code>:</dt>
<dd>element attributes
</dd>
</dl>
<p>Returns: header element</p>
</dd>
<dt><span id="HorizontalRule"><code>HorizontalRule ()</code></span></dt>
<dd><p>Creates a horizontal rule.</p>
<p>Returns: horizontal rule</p>
</dd>
<dt><span id="LineBlock"><code>LineBlock (content)</code></span></dt>
<dd><p>Creates a line block element.</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
</dl>
<p>Returns: line block element</p>
</dd>
<dt><span id="Null"><code>Null ()</code></span></dt>
<dd><p>Creates a null element.</p>
<p>Returns: null element</p>
</dd>
<dt><span id="OrderedList"><code>OrderedList (items[, listAttributes])</code></span></dt>
<dd><p>Creates an ordered list.</p>
<p>Parameters:</p>
<dl>
<dt><code>items</code>:</dt>
<dd>list items
</dd>
<dt><code>listAttributes</code>:</dt>
<dd>list parameters
</dd>
</dl>
<p>Returns: ordered list element</p>
</dd>
<dt><span id="Para"><code>Para (content)</code></span></dt>
<dd><p>Creates a para element.</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
</dl>
<p>Returns: paragraph element</p>
</dd>
<dt><span id="Plain"><code>Plain (content)</code></span></dt>
<dd><p>Creates a plain element.</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
</dl>
<p>Returns: plain element</p>
</dd>
<dt><span id="RawBlock"><code>RawBlock (format, text)</code></span></dt>
<dd><p>Creates a raw content block of the specified format.</p>
<p>Parameters:</p>
<dl>
<dt><code>format</code>:</dt>
<dd>format of content
</dd>
<dt><code>text</code>:</dt>
<dd>string content
</dd>
</dl>
<p>Returns: raw block element</p>
</dd>
<dt><span id="Table"><code>Table (caption, aligns, widths, headers, rows)</code></span></dt>
<dd><p>Creates a table element.</p>
<p>Parameters:</p>
<dl>
<dt><code>caption</code>:</dt>
<dd>table caption
</dd>
<dt><code>aligns</code>:</dt>
<dd>alignments
</dd>
<dt><code>widths</code>:</dt>
<dd>column widths
</dd>
<dt><code>headers</code>:</dt>
<dd>header row
</dd>
<dt><code>rows</code>:</dt>
<dd>table rows
</dd>
</dl>
<p>Returns: table element</p>
</dd>
</dl>
<h2 id="inline">Inline</h2>
<dl>
<dt><span id="Inline"><code>Inline</code></span></dt>
<dd><p>Inline element class</p>
</dd>
<dt><span id="Cite"><code>Cite (content, citations)</code></span></dt>
<dd><p>Creates a Cite inline element</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>List of inlines
</dd>
<dt><code>citations</code>:</dt>
<dd>List of citations
</dd>
</dl>
<p>Returns: citations element</p>
</dd>
<dt><span id="Code"><code>Code (text[, attr])</code></span></dt>
<dd><p>Creates a Code inline element</p>
<p>Parameters:</p>
<dl>
<dt><code>text</code>:</dt>
<dd>brief image description
</dd>
<dt><code>attr</code>:</dt>
<dd>additional attributes
</dd>
</dl>
<p>Returns: code element</p>
</dd>
<dt><span id="Emph"><code>Emph (content)</code></span></dt>
<dd><p>Creates an inline element representing emphasised text.</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
</dl>
<p>Returns: emphasis element</p>
</dd>
<dt><span id="Image"><code>Image (caption, src[, title[, attr]])</code></span></dt>
<dd><p>Creates a Image inline element</p>
<p>Parameters:</p>
<dl>
<dt><code>caption</code>:</dt>
<dd>text used to describe the image
</dd>
<dt><code>src</code>:</dt>
<dd>path to the image file
</dd>
<dt><code>title</code>:</dt>
<dd>brief image description
</dd>
<dt><code>attr</code>:</dt>
<dd>additional attributes
</dd>
</dl>
<p>Returns: image element</p>
</dd>
<dt><span id="LineBreak"><code>LineBreak ()</code></span></dt>
<dd><p>Create a LineBreak inline element</p>
<p>Returns: linebreak element</p>
</dd>
<dt><span id="Link"><code>Link (content, target[, title[, attr]])</code></span></dt>
<dd><p>Creates a link inline element, usually a hyperlink.</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>text for this link
</dd>
<dt><code>target</code>:</dt>
<dd>the link target
</dd>
<dt><code>title</code>:</dt>
<dd>brief link description
</dd>
<dt><code>attr</code>:</dt>
<dd>additional attributes
</dd>
</dl>
<p>Returns: image element</p>
</dd>
<dt><span id="Math"><code>Math (mathtype, text)</code></span></dt>
<dd><p>Creates a Math element, either inline or displayed.</p>
<p>Parameters:</p>
<dl>
<dt><code>mathtype</code>:</dt>
<dd>rendering specifier
</dd>
<dt><code>text</code>:</dt>
<dd>Math content
</dd>
</dl>
<p>Returns: Math element</p>
</dd>
<dt><span id="DisplayMath"><code>DisplayMath (text)</code></span></dt>
<dd><p>Creates a DisplayMath element (DEPRECATED).</p>
<p>Parameters:</p>
<dl>
<dt><code>text</code>:</dt>
<dd>Math content
</dd>
</dl>
<p>Returns: Math element</p>
</dd>
<dt><span id="InlineMath"><code>InlineMath (text)</code></span></dt>
<dd><p>Creates an InlineMath inline element (DEPRECATED).</p>
<p>Parameters:</p>
<dl>
<dt><code>text</code>:</dt>
<dd>Math content
</dd>
</dl>
<p>Returns: Math element</p>
</dd>
<dt><span id="Note"><code>Note (content)</code></span></dt>
<dd><p>Creates a Note inline element</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>footnote block content
</dd>
</dl>
</dd>
<dt><span id="Quoted"><code>Quoted (quotetype, content)</code></span></dt>
<dd><p>Creates a Quoted inline element given the quote type and quoted content.</p>
<p>Parameters:</p>
<dl>
<dt><code>quotetype</code>:</dt>
<dd>type of quotes to be used
</dd>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
</dl>
<p>Returns: quoted element</p>
</dd>
<dt><span id="SingleQuoted"><code>SingleQuoted (content)</code></span></dt>
<dd><p>Creates a single-quoted inline element (DEPRECATED).</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
</dl>
<p>Returns: quoted element</p>
<p>See also: <a href="#Quoted">Quoted</a></p>
</dd>
<dt><span id="DoubleQuoted"><code>DoubleQuoted (content)</code></span></dt>
<dd><p>Creates a single-quoted inline element (DEPRECATED).</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
</dl>
<p>Returns: quoted element</p>
<p>See also: <a href="#Quoted">Quoted</a></p>
</dd>
<dt><span id="RawInline"><code>RawInline (format, text)</code></span></dt>
<dd><p>Creates a RawInline inline element</p>
<p>Parameters:</p>
<dl>
<dt><code>format</code>:</dt>
<dd>format of the contents
</dd>
<dt><code>text</code>:</dt>
<dd>string content
</dd>
</dl>
<p>Returns: raw inline element</p>
</dd>
<dt><span id="SmallCaps"><code>SmallCaps (content)</code></span></dt>
<dd><p>Creates text rendered in small caps</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
</dl>
<p>Returns: smallcaps element</p>
</dd>
<dt><span id="SoftBreak"><code>SoftBreak ()</code></span></dt>
<dd><p>Creates a SoftBreak inline element.</p>
<p>Returns: softbreak element</p>
</dd>
<dt><span id="Space"><code>Space ()</code></span></dt>
<dd><p>Create a Space inline element</p>
<p>Returns: space element</p>
</dd>
<dt><span id="Span"><code>Span (content[, attr])</code></span></dt>
<dd><p>Creates a Span inline element</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
<dt><code>attr</code>:</dt>
<dd>additional attributes
</dd>
</dl>
<p>Returns: span element</p>
</dd>
<dt><span id="Str"><code>Str (text)</code></span></dt>
<dd><p>Creates a Str inline element</p>
<p>Parameters:</p>
<dl>
<dt><code>text</code>:</dt>
<dd>content
</dd>
</dl>
<p>Returns: string element</p>
</dd>
<dt><span id="Strikeout"><code>Strikeout (content)</code></span></dt>
<dd><p>Creates text which is striked out.</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
</dl>
<p>Returns: strikeout element</p>
</dd>
<dt><span id="Strong"><code>Strong (content)</code></span></dt>
<dd><p>Creates a Strong element, whose text is usually displayed in a bold font.</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
</dl>
<p>Returns: strong element</p>
</dd>
<dt><span id="Subscript"><code>Subscript (content)</code></span></dt>
<dd><p>Creates a Subscript inline element</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
</dl>
<p>Returns: subscript element</p>
</dd>
<dt><span id="Superscript"><code>Superscript (content)</code></span></dt>
<dd><p>Creates a Superscript inline element</p>
<p>Parameters:</p>
<dl>
<dt><code>content</code>:</dt>
<dd>inline content
</dd>
</dl>
<p>Returns: strong element</p>
</dd>
</dl>
<h2 id="element-components">Element components</h2>
<dl>
<dt><span id="Attr"><code>Attr ([identifier[, classes[, attributes]]])</code></span></dt>
<dd><p>Create a new set of attributes (Attr).</p>
<p>Parameters:</p>
<dl>
<dt><code>identifier</code>:</dt>
<dd>element identifier
</dd>
<dt><code>classes</code>:</dt>
<dd>element classes
</dd>
<dt><code>attributes</code>:</dt>
<dd>table containing string keys and values
</dd>
</dl>
<p>Returns: element attributes</p>
</dd>
<dt><span id="Citation"><code>Citation (id, mode[, prefix[, suffix[, note_num[, hash]]]])</code></span></dt>
<dd><p>Creates a single citation.</p>
<p>Parameters:</p>
<dl>
<dt><code>id</code>:</dt>
<dd>citation identifier (like a bibtex key)
</dd>
<dt><code>mode</code>:</dt>
<dd>citation mode
</dd>
<dt><code>prefix</code>:</dt>
<dd>citation prefix
</dd>
<dt><code>suffix</code>:</dt>
<dd>citation suffix
</dd>
<dt><code>note_num</code>:</dt>
<dd>note number
</dd>
<dt><code>hash</code>:</dt>
<dd>hash number
</dd>
</dl>
</dd>
</dl>
<h2 id="constants">Constants</h2>
<dl>
<dt><span id="AuthorInText"><code>AuthorInText</code></span></dt>
<dd><p>Author name is mentioned in the text.</p>
<p>See also: <a href="#Citation">Citation</a></p>
</dd>
<dt><span id="SuppressAuthor"><code>SuppressAuthor</code></span></dt>
<dd><p>Author name is suppressed.</p>
<p>See also: <a href="#Citation">Citation</a></p>
</dd>
<dt><span id="NormalCitation"><code>NormalCitation</code></span></dt>
<dd><p>Default citation style is used.</p>
<p>See also: <a href="#Citation">Citation</a></p>
</dd>
<dt><span id="AlignLeft"><code>AlignLeft</code></span></dt>
<dd><p>Table cells aligned left.</p>
<p>See also: <a href="#Table">Table</a></p>
</dd>
<dt><span id="AlignRight"><code>AlignRight</code></span></dt>
<dd><p>Table cells right-aligned.</p>
<p>See also: <a href="#Table">Table</a></p>
</dd>
<dt><span id="AlignCenter"><code>AlignCenter</code></span></dt>
<dd><p>Table cell content is centered.</p>
<p>See also: <a href="#Table">Table</a></p>
</dd>
<dt><span id="AlignDefault"><code>AlignDefault</code></span></dt>
<dd><p>Table cells are alignment is unaltered.</p>
<p>See also: <a href="#Table">Table</a></p>
</dd>
<dt><span id="DefaultDelim"><code>DefaultDelim</code></span></dt>
<dd><p>Default list number delimiters are used.</p>
<p>See also: <a href="#OrderedList">OrderedList</a></p>
</dd>
<dt><span id="Period"><code>Period</code></span></dt>
<dd><p>List numbers are delimited by a period.</p>
<p>See also: <a href="#OrderedList">OrderedList</a></p>
</dd>
<dt><span id="OneParen"><code>OneParen</code></span></dt>
<dd><p>List numbers are delimited by a single parenthesis.</p>
<p>See also: <a href="#OrderedList">OrderedList</a></p>
</dd>
<dt><span id="TwoParens"><code>TwoParens</code></span></dt>
<dd><p>List numbers are delimited by a double parentheses.</p>
<p>See also: <a href="#OrderedList">OrderedList</a></p>
</dd>
<dt><span id="DefaultStyle"><code>DefaultStyle</code></span></dt>
<dd><p>List are numbered in the default style</p>
<p>See also: <a href="#OrderedList">OrderedList</a></p>
</dd>
<dt><span id="Example"><code>Example</code></span></dt>
<dd><p>List items are numbered as examples.</p>
<p>See also: <a href="#OrderedList">OrderedList</a></p>
</dd>
<dt><span id="Decimal"><code>Decimal</code></span></dt>
<dd><p>List are numbered using decimal integers.</p>
<p>See also: <a href="#OrderedList">OrderedList</a></p>
</dd>
<dt><span id="LowerRoman"><code>LowerRoman</code></span></dt>
<dd><p>List are numbered using lower-case roman numerals.</p>
<p>See also: <a href="#OrderedList">OrderedList</a></p>
</dd>
<dt><span id="UpperRoman"><code>UpperRoman</code></span></dt>
<dd><p>List are numbered using upper-case roman numerals</p>
<p>See also: <a href="#OrderedList">OrderedList</a></p>
</dd>
<dt><span id="LowerAlpha"><code>LowerAlpha</code></span></dt>
<dd><p>List are numbered using lower-case alphabetic characters.</p>
<p>See also: <a href="#OrderedList">OrderedList</a></p>
</dd>
<dt><span id="UpperAlpha"><code>UpperAlpha</code></span></dt>
<dd><p>List are numbered using upper-case alphabetic characters.</p>
<p>See also: <a href="#OrderedList">OrderedList</a></p>
</dd>
</dl>
<h2 id="helper-functions">Helper functions</h2>
<dl>
<dt><span id="pipe"><code>pipe (command, args, input)</code></span></dt>
<dd><p>Runs command with arguments, passing it some input, and returns the output.</p>
<p>Returns:</p>
<ul>
<li>Output of command.</li>
</ul>
<p>Raises:</p>
<ul>
<li>A table containing the keys <code>command</code>, <code>error_code</code>, and <code>output</code> is thrown if the command exits with a non-zero error code.</li>
</ul>
<p>Usage:</p>
<pre><code>local output = pandoc.pipe(&quot;sed&quot;, {&quot;-e&quot;,&quot;s/a/b/&quot;}, &quot;abc&quot;)</code></pre>
</dd>
<dt><span id="walk_block"><code>walk_block (element, filter)</code></span></dt>
<dd><p>Apply a filter inside a block element, walking its contents.</p>
<p>Parameters:</p>
<dl>
<dt><code>element</code>:</dt>
<dd>the block element
</dd>
<dt><code>filter</code>:</dt>
<dd>a lua filter (table of functions) to be applied within the block element
</dd>
</dl>
<p>Returns: the transformed block element</p>
</dd>
<dt><span id="walk_inline"><code>walk_inline (element, filter)</code></span></dt>
<dd><p>Apply a filter inside an inline element, walking its contents.</p>
<p>Parameters:</p>
<dl>
<dt><code>element</code>:</dt>
<dd>the inline element
</dd>
<dt><code>filter</code>:</dt>
<dd>a lua filter (table of functions) to be applied within the inline element
</dd>
</dl>
<p>Returns: the transformed inline element</p>
</dd>
<dt><span id="read"><code>read (markup[, format])</code></span></dt>
<dd><p>Parse the given string into a Pandoc document.</p>
<p>Parameters:</p>
<dl>
<dt><code>markup</code>:</dt>
<dd>the markup to be parsed
</dd>
<dt><code>format</code>:</dt>
<dd>format specification, defaults to &quot;markdown&quot;.
</dd>
</dl>
<p>Returns: pandoc document</p>
<p>Usage:</p>
<pre><code>local org_markup = &quot;/emphasis/&quot;  -- Input to be read
local document = pandoc.read(org_markup, &quot;org&quot;)
-- Get the first block of the document
local block = document.blocks[1]
-- The inline element in that block is an `Emph`
assert(block.content[1].t == &quot;Emph&quot;)</code></pre>
</dd>
</dl>
<h1 id="module-pandoc.utils">Module pandoc.utils</h1>
<p>This module exposes internal pandoc functions and utility functions.</p>
<dl>
<dt><span id="utils-hierarchicalize"><code>hierarchicalize (blocks)</code></span></dt>
<dd><p>Convert list of blocks into an hierarchical list. An hierarchical elements is either a normal block (but no Header), or a <code>Sec</code> element. The latter has the following fields:</p>
<ul>
<li>level: level in the document hierarchy;</li>
<li>numbering: list of integers of length <code>level</code>, specifying the absolute position of the section in the document;</li>
<li>attr: section attributes (see <a href="#Attr">Attr</a>);</li>
<li>contents: nested list of hierarchical elements.</li>
</ul>
<p>Returns:</p>
<ul>
<li>List of hierarchical elements</li>
</ul>
<p>Usage:</p>
<pre><code>local blocks = {
  pandoc.Header(2, pandoc.Str &#39;first&#39;),
  pandoc.Header(2, pandoc.Str &#39;second&#39;),
}
local elements = pandoc.utils.hierarchicalize(blocks)
print(table.concat(elements[1].numbering, &#39;.&#39;)) -- 0.1
print(table.concat(elements[2].numbering, &#39;.&#39;)) -- 0.2</code></pre>
</dd>
<dt><span id="utils-run_json_filter"><code>run_json_filter (doc, filter[, args])</code></span></dt>
<dd><p>Filter the given doc by passing it through the a JSON filter.</p>
<p>Parameters:</p>
<dl>
<dt><code>doc</code>:</dt>
<dd>the Pandoc document to filter
</dd>
<dt><code>filter</code>:</dt>
<dd>filter to run
</dd>
<dt><code>args</code>:</dt>
<dd>list of arguments passed to the filter. Defaults to <code>{FORMAT}</code>.
</dd>
</dl>
<p>Returns:</p>
<ul>
<li>(<a href="#Pandoc">Pandoc</a>) Filtered document</li>
</ul>
<p>Usage:</p>
<pre><code>-- Assumes `some_blocks` contains blocks for which a
-- separate literature section is required.
local sub_doc = pandoc.Pandoc(some_blocks, metadata)
sub_doc_with_bib = pandoc.utils.run_json_filter(
  sub_doc,
  &#39;pandoc-citeproc&#39;
)
some_blocks = sub_doc.blocks -- some blocks with bib</code></pre>
</dd>
<dt><span id="utils-normalize_date"><code>normalize_date (date_string)</code></span></dt>
<dd><p>Parse a date and convert (if possible) to “YYYY-MM-DD” format. We limit years to the range 1601-9999 (ISO 8601 accepts greater than or equal to 1583, but MS Word only accepts dates starting 1601).</p>
<p>Returns:</p>
<ul>
<li>A date string, or nil when the conversion failed.</li>
</ul>
</dd>
<dt><span id="utils-sha1"><code>sha1 (contents)</code></span></dt>
<dd><p>Returns the SHA1 has of the contents.</p>
<p>Returns:</p>
<ul>
<li>SHA1 hash of the contents.</li>
</ul>
<p>Usage:</p>
<pre><code>local fp = pandoc.utils.sha1(&quot;foobar&quot;)</code></pre>
</dd>
<dt><span id="utils-stringify"><code>stringify (element)</code></span></dt>
<dd><p>Converts the given element (Pandoc, Meta, Block, or Inline) into a string with all formatting removed.</p>
<p>Returns:</p>
<ul>
<li>A plain string representation of the given element.</li>
</ul>
<p>Usage:</p>
<pre><code>local inline = pandoc.Emph{pandoc.Str &#39;Moin&#39;}
-- outputs &quot;Moin&quot;
print(pandoc.utils.stringify(inline))</code></pre>
</dd>
<dt><span id="utils-to_roman_numeral"><code>to_roman_numeral (integer)</code></span></dt>
<dd><p>Converts an integer &lt; 4000 to uppercase roman numeral.</p>
<p>Returns:</p>
<ul>
<li>A roman numeral string.</li>
</ul>
<p>Usage:</p>
<pre><code>local to_roman_numeral = pandoc.utils.to_roman_numeral
local pandoc_birth_year = to_roman_numeral(2006)
-- pandoc_birth_year == &#39;MMVI&#39;</code></pre>
</dd>
</dl>
<h1 id="module-pandoc.mediabag">Module pandoc.mediabag</h1>
<p>The <code>pandoc.mediabag</code> module allows accessing pandoc’s media storage. The “media bag” is used when pandoc is called with the <code>--extract-media</code> or <code>--standalone</code>/<code>-s</code> option.</p>
<dl>
<dt><span id="mediabag-insert"><code>insert (filepath, mime_type, contents)</code></span></dt>
<dd><p>Adds a new entry to pandoc’s media bag.</p>
<p>Parameters:</p>
<dl>
<dt><code>filepath</code>:</dt>
<dd>filename and path relative to the output folder.
</dd>
<dt><code>mime_type</code>:</dt>
<dd>the file’s MIME type
</dd>
<dt><code>contents</code>:</dt>
<dd>the binary contents of the file.
</dd>
</dl>
<p>Usage:</p>
<pre><code>local fp = &quot;media/hello.txt&quot;
local mt = &quot;text/plain&quot;
local contents = &quot;Hello, World!&quot;
pandoc.mediabag(fp, mt, contents)</code></pre>
</dd>
<dt><span id="mediabag-list"><code>list ()</code></span></dt>
<dd><p>Get a summary of the current media bag contents.</p>
<p>Returns: A list of elements summarizing each entry in the media bag. The summary item contains the keys <code>path</code>, <code>type</code>, and <code>length</code>, giving the filepath, MIME type, and length of contents in bytes, respectively.</p>
<p>Usage:</p>
<pre><code>-- calculate the size of the media bag.
local mb_items = pandoc.mediabag.list()
local sum = 0
for i = 1, #mb_items:
    sum = sum + mb_items[i].length
end
print(sum)</code></pre>
</dd>
<dt><span id="mediabag-lookup"><code>lookup (filepath)</code></span></dt>
<dd><p>Lookup a media item in the media bag, returning mime type and contents.</p>
<p>Parameters:</p>
<dl>
<dt><code>filepath</code>:</dt>
<dd>name of the file to look up.
</dd>
</dl>
<p>Returns:</p>
<ul>
<li>the entries MIME type, or nil if the file was not found.</li>
<li>contents of the file, or nil if the file was not found.</li>
</ul>
<p>Usage:</p>
<pre><code>local filename = &quot;media/diagram.png&quot;
local mt, contents = pandoc.mediabag.lookup(filename)</code></pre>
</dd>
<dt><span id="mediabag-fetch"><code>fetch (source, base_url)</code></span></dt>
<dd><p>Fetches the given source from a URL or local file. Returns two values: the contents of the file and the mime type (or an empty string).</p>
<p>Returns:</p>
<ul>
<li>the entries MIME type, or nil if the file was not found.</li>
<li>contents of the file, or nil if the file was not found.</li>
</ul>
<p>Usage:</p>
<pre><code>local diagram_url = &quot;https://pandoc.org/diagram.jpg&quot;
local contents = pandoc.mediabag.fetch(diagram_url, &quot;.&quot;)</code></pre>
</dd>
</dl>
<h1 id="module-pandoc.list">Module pandoc.List</h1>
<p>Pandoc's List type and helper methods</p>
<h2 id="metamethods">Metamethods</h2>
<dl>
<dt><span id="pandoc.List:__concat"><code>pandoc.List:__concat (list)</code></span></dt>
<dd><p>Concatenates two lists.</p>
<p>Parameters:</p>
<dl>
<dt><code>list</code>:</dt>
<dd>second list concatenated to the first
</dd>
</dl>
<p>Returns: a new list containing all elements from list1 and list2</p>
</dd>
</dl>
<h2 id="methods">Methods</h2>
<dl>
<dt><span id="pandoc.List:clone"><code>pandoc.List:clone ()</code></span></dt>
<dd><p>Returns a (shallow) copy of the list.</p>
</dd>
<dt><span id="pandoc.List:includes"><code>pandoc.List:includes (needle, init)</code></span></dt>
<dd><p>Checks if the list has an item equal to the given needle.</p>
<p>Parameters:</p>
<dl>
<dt><code>needle</code>:</dt>
<dd>item to search for
</dd>
<dt><code>init</code>:</dt>
<dd>index at which the search is started
</dd>
</dl>
<p>Returns: true if a list item is equal to the needle, false otherwise</p>
</dd>
<dt><span id="pandoc.List:find"><code>pandoc.List:find (needle, init)</code></span></dt>
<dd><p>Returns the value and index of the first occurrence of the given item.</p>
<p>Parameters:</p>
<dl>
<dt><code>needle</code>:</dt>
<dd>item to search for
</dd>
<dt><code>init</code>:</dt>
<dd>index at which the search is started
</dd>
</dl>
<p>Returns: first item equal to the needle, or nil if no such item exists.</p>
</dd>
<dt><span id="pandoc.List:find_if"><code>pandoc.List:find_if (pred, init)</code></span></dt>
<dd><p>Returns the value and index of the first element for which the predicate holds true.</p>
<p>Parameters:</p>
<dl>
<dt><code>pred</code>:</dt>
<dd>the predicate function
</dd>
<dt><code>init</code>:</dt>
<dd>index at which the search is started
</dd>
</dl>
<p>Returns: first item for which `test` succeeds, or nil if no such item exists.</p>
</dd>
<dt><span id="pandoc.List:extend"><code>pandoc.List:extend (list)</code></span></dt>
<dd><p>Adds the given list to the end of this list.</p>
<p>Parameters:</p>
<dl>
<dt><code>list</code>:</dt>
<dd>list to appended
</dd>
</dl>
</dd>
<dt><span id="pandoc.List:map"><code>pandoc.List:map (fn)</code></span></dt>
<dd><p>Returns a copy of the current list by applying the given function to all elements.</p>
<p>Parameters:</p>
<dl>
<dt><code>fn</code>:</dt>
<dd>function which is applied to all list items.
</dd>
</dl>
</dd>
<dt><span id="pandoc.List:filter"><code>pandoc.List:filter (pred)</code></span></dt>
<dd><p>Returns a new list containing all items satisfying a given condition.</p>
<p>Parameters:</p>
<dl>
<dt><code>pred</code>:</dt>
<dd>condition items must satisfy.
</dd>
</dl>
<p>Returns: a new list containing all items for which `test` was true.</p>
</dd>
</dl>
        </div>
      </main>
    </div>
    <footer>
    </footer>
  </div>
</body>
</html>
